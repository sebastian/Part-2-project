<html>
<head><title>.eunit/webmachine_router.COVER.html</title></head><body bgcolor=white text=black>
<pre>
File generated from /Users/seb/Documents/part2project/app/deps/webmachine/.eunit/webmachine_router.erl by COVER 2010-10-28 at 14:19:55

****************************************************************************

        |  %% @author Kevin A. Smith &lt;ksmith@basho.com&gt;
        |  %% @copyright 2007-2010 Basho Technologies
        |  %%
        |  %%    Licensed under the Apache License, Version 2.0 (the "License");
        |  %%    you may not use this file except in compliance with the License.
        |  %%    You may obtain a copy of the License at
        |  %%
        |  %%        http://www.apache.org/licenses/LICENSE-2.0
        |  %%
        |  %%    Unless required by applicable law or agreed to in writing, software
        |  %%    distributed under the License is distributed on an "AS IS" BASIS,
        |  %%    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
        |  %%    See the License for the specific language governing permissions and
        |  %%    limitations under the License.
        |  
        |  %% @doc Module to add and remove dynamic routes to webmachine's routing
        |  %%      table. Dynamic routes are not persistent between executions of
        |  %%      a webmachine application. They will need to be added to the
        |  %%      the table each time webmachine restarts.
        |  -module(webmachine_router).
        |  
        |  -include_lib("eunit/include/eunit.hrl").
        |  
        |  -behaviour(gen_server).
        |  
        |  %% API
        |  -export([start_link/0,
        |           add_route/1,
        |           remove_route/1,
        |           remove_resource/1]).
        |  
        |  %% gen_server callbacks
        |  -export([init/1,
        |           handle_call/3,
        |           handle_cast/2,
        |           handle_info/2,
        |           terminate/2,
        |           code_change/3]).
        |  
        |  %% @type hostmatchterm() = {hostmatch(), [pathmatchterm()]}.
        |  % The dispatch configuration contains a list of these terms, and the
        |  % first one whose host and one pathmatchterm match is used.
        |  
        |  %% @type pathmatchterm() = {[pathterm()], matchmod(), matchopts()}.
        |  % The dispatch configuration contains a list of these terms, and the
        |  % first one whose list of pathterms matches the input path is used.
        |  
        |  %% @type pathterm() = '*' | string() | atom().
        |  % A list of pathterms is matched against a '/'-separated input path.
        |  % The '*' pathterm matches all remaining tokens.
        |  % A string pathterm will match a token of exactly the same string.
        |  % Any atom pathterm other than '*' will match any token and will
        |  % create a binding in the result if a complete match occurs.
        |  
        |  %% @type matchmod() = atom().
        |  % This atom, if present in a successful matchterm, will appear in
        |  % the resulting dispterm.  In Webmachine this is used to name the
        |  % resource module that will handle the matching request.
        |  
        |  %% @type matchopts() = [term()].
        |  % This term, if present in a successful matchterm, will appear in
        |  % the resulting dispterm.  In Webmachine this is used to provide
        |  % arguments to the resource module handling the matching request.
        |  
        |  -define(SERVER, ?MODULE).
        |  
        |  %% @spec add_route(hostmatchterm() | pathmatchterm()) -&gt; ok
        |  %% @doc Adds a route to webmachine's route table. The route should
        |  %%      be the format documented here:
        |  %% http://bitbucket.org/justin/webmachine/wiki/DispatchConfiguration
        |  add_route(Route) -&gt;
     6..|      gen_server:call(?SERVER, {add_route, Route}, infinity).
        |  
        |  %% @spec remove_route(hostmatchterm() | pathmatchterm()) -&gt; ok
        |  %% @doc Removes a route from webamchine's route table. The route
        |  %%      route must be properly formatted
        |  %% @see add_route/2
        |  remove_route(Route) -&gt;
     1..|      gen_server:call(?SERVER, {remove_route, Route}, infinity).
        |  
        |  %% @spec remove_resource(atom()) -&gt; ok
        |  %% @doc Removes all routes for a specific resource module.
        |  remove_resource(Resource) when is_atom(Resource) -&gt;
     1..|      gen_server:call(?SERVER, {remove_resource, Resource}, infinity).
        |  
        |  %% @spec start_link() -&gt; {ok, pid()} | {error, any()}
        |  %% @doc Starts the webmachine_router gen_server.
        |  start_link() -&gt;
<font color=red>     0..|    gen_server:start_link({local, ?SERVER}, ?MODULE, [], []).</font>
        |  
        |  %% @private
        |  init([]) -&gt;
     3..|    {ok, []}.
        |  
        |  %% @private
        |  handle_call(get_routes, _From, State) -&gt;
     4..|      {reply, get_dispatch_list(), State};
        |  
        |  handle_call({remove_resource, Resource}, _From, State) -&gt;
     1..|      DL = [D || D &lt;- get_dispatch_list(),
     3..|                 filter_by_resource(D, Resource)],
     1..|      {reply, set_dispatch_list(DL), State};
        |  
        |  handle_call({remove_route, Route}, _From, State) -&gt;
     1..|      DL = [D || D &lt;- get_dispatch_list(),
     1..|                 D /= Route],
     1..|      {reply, set_dispatch_list(DL), State};
        |  
        |  handle_call({add_route, Route}, _From, State) -&gt;
     6..|      DL = [Route|[D || D &lt;- get_dispatch_list(),
     4..|                        D /= Route]],
     6..|      {reply, set_dispatch_list(DL), State};
        |  
        |  handle_call(_Request, _From, State) -&gt;
<font color=red>     0..|    {reply, ignore, State}.</font>
        |  
        |  %% @private
        |  handle_cast(_Msg, State) -&gt;
<font color=red>     0..|    {noreply, State}.</font>
        |  
        |  %% @private
        |  handle_info(_Info, State) -&gt;
<font color=red>     0..|    {noreply, State}.</font>
        |  
        |  %% @private
        |  terminate(_Reason, _State) -&gt;
<font color=red>     0..|    ok.</font>
        |  
        |  %% @private
        |  code_change(_OldVsn, State, _Extra) -&gt;
<font color=red>     0..|    {ok, State}.</font>
        |  
        |  %% Internal functions
        |  filter_by_resource({_, {_, Resource, _}}, Resource) -&gt;
<font color=red>     0..|      false;</font>
        |  filter_by_resource({_, {_, _, _}}, _Resource) -&gt;
<font color=red>     0..|      true;</font>
        |  filter_by_resource({_, Resource, _}, Resource) -&gt;
     2..|      false;
        |  filter_by_resource({_, _, _}, _Resource) -&gt;
     1..|      true.
        |  
        |  get_dispatch_list() -&gt;
    12..|      {ok, Dispatch} = application:get_env(webmachine, dispatch_list),
    12..|      Dispatch.
        |  
        |  set_dispatch_list(DispatchList) -&gt;
     8..|      ok = application:set_env(webmachine, dispatch_list, DispatchList),
     8..|      ok.
        |  
        |  %% For unit tests only
        |  start() -&gt;
     3..|      gen_server:start({local, ?SERVER}, ?MODULE, [], []).
        |  
        |  get_routes() -&gt;
     4..|      gen_server:call(?SERVER, get_routes, infinity).
        |  
        |  %% Tests
        |  add_remove_route_test() -&gt;
     1..|      application:set_env(webmachine, dispatch_list, []),
     1..|      {ok, Pid} = start(),
     1..|      PathSpec = {["foo"], foo, []},
     1..|      webmachine_router:add_route(PathSpec),
     1..|      [PathSpec] = get_routes(),
     1..|      webmachine_router:remove_route(PathSpec),
     1..|      [] = get_routes(),
     1..|      exit(Pid, kill).
        |  
        |  add_remove_resource_test() -&gt;
     1..|      application:set_env(webmachine, dispatch_list, []),
     1..|      {ok, Pid} = start(),
     1..|      PathSpec1 = {["foo"], foo, []},
     1..|      PathSpec2 = {["bar"], foo, []},
     1..|      PathSpec3 = {["baz"], bar, []},
     1..|      webmachine_router:add_route(PathSpec1),
     1..|      webmachine_router:add_route(PathSpec2),
     1..|      webmachine_router:add_route(PathSpec3),
     1..|      webmachine_router:remove_resource(foo),
     1..|      [PathSpec3] = get_routes(),
     1..|      exit(Pid, kill).
        |  
        |  no_dupe_path_test() -&gt;
     1..|      application:set_env(webmachine, dispatch_list, []),
     1..|      {ok, Pid} = start(),
     1..|      PathSpec = {["foo"], foo, []},
     1..|      webmachine_router:add_route(PathSpec),
     1..|      webmachine_router:add_route(PathSpec),
     1..|      [PathSpec] = get_routes(),
     1..|      exit(Pid, kill).
</pre>
</body>
</html>
