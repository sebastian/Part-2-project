<html>
<head><title>.eunit/wmtrace_resource.COVER.html</title></head><body bgcolor=white text=black>
<pre>
File generated from /Users/seb/Documents/part2project/app/deps/webmachine/.eunit/wmtrace_resource.erl by COVER 2010-10-28 at 14:19:55

****************************************************************************

        |  %% @author Bryan Fink &lt;bryan@basho.com&gt;
        |  %% @doc Webmachine trace file interpretter.
        |  -module(wmtrace_resource).
        |  
        |  -export([add_dispatch_rule/2,
        |           remove_dispatch_rules/0]).
        |  
        |  -export([ping/2,
        |           init/1,
        |           resource_exists/2,
        |           content_types_provided/2,
        |           produce_html/2,
        |           produce_javascript/2,
        |           produce_map/2,
        |           produce_css/2]).
        |  
        |  -include("include/wm_reqdata.hrl").
        |  
        |  -record(ctx, {trace_dir, trace}).
        |  
        |  -define(MAP_EXTERNAL, "static/map.png").
        |  -define(MAP_INTERNAL, "http-headers-status-v3.png").
        |  -define(SCRIPT_EXTERNAL, "static/wmtrace.js").
        |  -define(SCRIPT_INTERNAL, "wmtrace.js").
        |  -define(STYLE_EXTERNAL, "static/wmtrace.css").
        |  -define(STYLE_INTERNAL, "wmtrace.css").
        |  
        |  %%
        |  %% Dispatch Modifiers
        |  %%
        |  
        |  %% @spec add_dispatch_rule(string(), string()) -&gt; ok
        |  %% @doc Add a dispatch rule to point at wmtrace_resource.
        |  %%      Example: to serve wmtrace_resource from
        |  %%        http://yourhost/dev/wmtrace/
        |  %%               with trace files on disk at
        |  %%        priv/traces
        |  %%               call:
        |  %%        add_dispatch_rule("dev/wmtrace", "priv/traces")
        |  add_dispatch_rule(BasePath, TracePath) when is_list(BasePath),
        |                                              is_list(TracePath) -&gt;
<font color=red>     0..|      Parts = string:tokens(BasePath, "/"),</font>
<font color=red>     0..|      webmachine_router:add_route({Parts ++ ['*'], ?MODULE, [{trace_dir, TracePath}]}).</font>
        |  
        |  %% @spec remove_dispatch_rules() -&gt; ok
        |  %% @doc Remove all dispatch rules pointing to wmtrace_resource.
        |  remove_dispatch_rules() -&gt;
<font color=red>     0..|      webmachine_router:remove_resource(?MODULE).</font>
        |  
        |  %%
        |  %% Resource
        |  %%
        |  
        |  ping(ReqData, State) -&gt;
<font color=red>     0..|      {pong, ReqData, State}.</font>
        |  
        |  init(Config) -&gt;
<font color=red>     0..|      {trace_dir, TraceDir} = proplists:lookup(trace_dir, Config),</font>
<font color=red>     0..|      {trace_dir_exists, true} = {trace_dir_exists, filelib:is_dir(TraceDir)},</font>
<font color=red>     0..|      {ok, #ctx{trace_dir=TraceDir}}.</font>
        |  
        |  resource_exists(RD, Ctx) -&gt;
<font color=red>     0..|      case wrq:disp_path(RD) of</font>
        |          [] -&gt;
<font color=red>     0..|              case lists:reverse(wrq:raw_path(RD)) of</font>
        |                  [$/|_] -&gt;
<font color=red>     0..|                      {true, RD, Ctx};</font>
        |                  _ -&gt;
<font color=red>     0..|                      {{halt, 303},</font>
        |                       wrq:set_resp_header("Location",
        |                                           wrq:raw_path(RD)++"/",
        |                                           RD),
        |                       Ctx}
        |              end;
        |          ?MAP_EXTERNAL -&gt;
<font color=red>     0..|              {filelib:is_file(wm_path(?MAP_INTERNAL)), RD, Ctx};</font>
        |          ?SCRIPT_EXTERNAL -&gt;
<font color=red>     0..|              {filelib:is_file(wm_path(?SCRIPT_INTERNAL)), RD, Ctx};</font>
        |          ?STYLE_EXTERNAL -&gt;
<font color=red>     0..|              {filelib:is_file(wm_path(?STYLE_INTERNAL)), RD, Ctx};</font>
        |          TraceName -&gt;
<font color=red>     0..|              TracePath = filename:join([Ctx#ctx.trace_dir, TraceName]),</font>
<font color=red>     0..|              {filelib:is_file(TracePath), RD, Ctx#ctx{trace=TracePath}}</font>
        |      end.
        |  
        |  wm_path(File) -&gt;
<font color=red>     0..|      filename:join([code:priv_dir(webmachine), "trace", File]).</font>
        |  
        |  content_types_provided(RD, Ctx) -&gt;
<font color=red>     0..|      case wrq:disp_path(RD) of</font>
        |          ?MAP_EXTERNAL -&gt;
<font color=red>     0..|              {[{"image/png", produce_map}], RD, Ctx};</font>
        |          ?SCRIPT_EXTERNAL -&gt;
<font color=red>     0..|              {[{"text/javascript", produce_javascript}], RD, Ctx};</font>
        |          ?STYLE_EXTERNAL -&gt;
<font color=red>     0..|              {[{"text/css", produce_css}], RD, Ctx};</font>
        |          _ -&gt;
<font color=red>     0..|              {[{"text/html", produce_html}], RD, Ctx}</font>
        |      end.
        |  
        |  produce_html(RD, Ctx=#ctx{trace=undefined}) -&gt;
<font color=red>     0..|      Dir = filename:absname(Ctx#ctx.trace_dir),</font>
<font color=red>     0..|      Files = lists:reverse(</font>
        |                lists:sort(
        |                  filelib:fold_files(Dir,
        |                                     ".*\.wmtrace",
        |                                     false,
        |                                     fun(F, Acc) -&gt;
<font color=red>     0..|                                             [filename:basename(F)|Acc]</font>
        |                                     end,
        |                                     []))),
<font color=red>     0..|      {trace_list_html(Dir, Files), RD, Ctx};</font>
        |  produce_html(RD, Ctx) -&gt;
<font color=red>     0..|      Filename = filename:absname(Ctx#ctx.trace),</font>
<font color=red>     0..|      {ok, Data} = file:consult(Filename),</font>
<font color=red>     0..|      {trace_html(Filename, Data), RD, Ctx}.</font>
        |  
        |  trace_list_html(Dir, Files) -&gt;
<font color=red>     0..|      html([],</font>
        |           [head([],
        |                 title([], ["Webmachine Trace List for ",Dir])),
        |            body([],
        |                 [h1([], ["Traces in ",Dir]),
        |                  ul([],
<font color=red>     0..|                     [ li([], a([{"href", F}], F)) || F &lt;- Files ])</font>
        |                 ])
        |           ]).
        |  
        |  trace_html(Filename, Data) -&gt;
<font color=red>     0..|      {Request, Response, Trace} = encode_trace(Data),</font>
<font color=red>     0..|      html([],</font>
        |           [head([],
        |                 [title([],["Webmachine Trace ",Filename]),
        |                  linkblock([{"rel", "stylesheet"},
        |                             {"type", "text/css"},
        |                             {"href", "static/wmtrace.css"}],
        |                            []),
        |                  script([{"type", "text/javascript"},
        |                          {"src", "static/wmtrace.js"}],
        |                         []),
        |                  script([{"type", "text/javascript"}],
        |                         mochiweb_html:escape(
        |                           lists:flatten(
        |                             ["var request=",Request,";\n"
        |                              "var response=",Response,";\n"
        |                              "var trace=",Trace,";"])))
        |                 ]),
        |            body([],
        |                 [divblock([{"id", "zoompanel"}],
        |                           [button([{"id", "zoomout"}], ["zoom out"]),
        |                            button([{"id", "zoomin"}], ["zoom in"])
        |                           ]),
        |                  canvas([{"id", "v3map"},
        |                          {"width", "3138"},
        |                          {"height", "2184"}],
        |                         []),
        |                  divblock([{"id", "sizetest"}], []),
        |                  divblock([{"id", "preview"}],
        |                           [divblock([{"id", "previewid"}],[]),
        |                            ul([{"id", "previewcalls"}], [])
        |                           ]),
        |                  divblock([{"id", "infopanel"}],
        |                           [divblock([{"id", "infocontrols"}],
        |                                     [divblock([{"id", "requesttab"},
        |                                                {"class", "selectedtab"}],"Q"),
        |                                      divblock([{"id", "responsetab"}], "R"),
        |                                      divblock([{"id", "decisiontab"}], "D")
        |                                     ]),
        |                            divblock([{"id", "requestdetail"}],
        |                                     [divblock([],
        |                                               [span([{"id", "requestmethod"}], []),
        |                                                " ",
        |                                                span([{"id", "requestpath"}], [])]),
        |                                      ul([{"id", "requestheaders"}], []),
        |                                      divblock([{"id", "requestbody"}],
        |                                               [])
        |                                     ]),
        |                            divblock([{"id", "responsedetail"}],
        |                                     [divblock([{"id", "responsecode"}], []),
        |                                      ul([{"id", "responseheaders"}], []),
        |                                      divblock([{"id", "responsebody"}], [])
        |                                     ]),
        |                            divblock([{"id", "decisiondetail"}],
        |                                     [divblock([],
        |                                               ["Decision: ",
        |                                                select([{"id", "decisionid"}], [])
        |                                               ]),
        |                                      divblock([],
        |                                               ["Calls:",
        |                                                select([{"id", "decisioncalls"}], [])
        |                                               ]),
        |                                      divblock([], "Input:"),
        |                                      pre([{"id", "callinput"}], []),
        |                                      divblock([], "Output:"),
        |                                      pre([{"id", "calloutput"}], [])
        |                                     ])
        |                           ])
        |                 ])
        |           ]).
        |  
        |  produce_javascript(RD, Ctx) -&gt;
<font color=red>     0..|      {ok, Script} = file:read_file(wm_path(?SCRIPT_INTERNAL)),</font>
<font color=red>     0..|      {Script, RD, Ctx}.</font>
        |  
        |  produce_map(RD, Ctx) -&gt;
<font color=red>     0..|      {ok, Map} = file:read_file(wm_path(?MAP_INTERNAL)),</font>
<font color=red>     0..|      {Map, RD, Ctx}.</font>
        |  
        |  produce_css(RD, Ctx) -&gt;
<font color=red>     0..|      {ok, Script} = file:read_file(wm_path(?STYLE_INTERNAL)),</font>
<font color=red>     0..|      {Script, RD, Ctx}.</font>
        |  
        |  %%
        |  %% Trace Encoding
        |  %%
        |  
        |  encode_trace(Data) -&gt;
<font color=red>     0..|      {Request, Response, Trace} = aggregate_trace(Data),</font>
<font color=red>     0..|      {mochijson:encode(encode_request(Request)),</font>
        |       mochijson:encode(encode_response(Response)),
<font color=red>     0..|       mochijson:encode({array, [ encode_trace_part(P) || P &lt;- Trace ]})}.</font>
        |  
        |  aggregate_trace(RawTrace) -&gt;
<font color=red>     0..|      {Request, Response, Trace} = lists:foldl(fun aggregate_trace_part/2,</font>
        |                                               {undefined, 500, []},
        |                                               RawTrace),
<font color=red>     0..|      {Request, Response, lists:reverse(Trace)}.</font>
        |  
        |  aggregate_trace_part({decision, Decision}, {Q, R, Acc}) -&gt;
<font color=red>     0..|      BDN = base_decision_name(Decision),</font>
<font color=red>     0..|      case Acc of</font>
<font color=red>     0..|          [{BDN,_}|_] -&gt; {Q, R, Acc}; %% subdecision (ex. v3b13b)</font>
        |          _ -&gt;
<font color=red>     0..|              {Q, R, [{base_decision_name(Decision), []}|Acc]}</font>
        |      end;
        |  aggregate_trace_part({attempt, Module, Function, Args},
        |                       {Q, R, [{Decision,Calls}|Acc]}) -&gt;
<font color=red>     0..|      {maybe_extract_request(Function, Args, Q),</font>
        |       R, [{Decision,[{Module, Function, Args, wmtrace_null}|Calls]}|Acc]};
        |  aggregate_trace_part({result, Module, Function, Result},
        |                       {Q, R, [{Decision,[{Module,Function,Args,_}|Calls]}|Acc]}) -&gt;
<font color=red>     0..|      {Q, maybe_extract_response(Function, Result, R),</font>
        |       [{Decision,[{Module, Function, Args, Result}|Calls]}|Acc]};
        |  aggregate_trace_part({not_exported, Module, Function, Args},
        |                       {Q, R, [{Decision,Calls}|Acc]}) -&gt;
<font color=red>     0..|      {Q, maybe_extract_response(Function, Args, R),</font>
        |       [{Decision,[{Module, Function, Args, wmtrace_not_exported}|Calls]}
        |        |Acc]}.
        |  
        |  maybe_extract_request(ping, [ReqData,_], _) -&gt;
<font color=red>     0..|      ReqData;</font>
        |  maybe_extract_request(_, _, R) -&gt;
<font color=red>     0..|      R.</font>
        |  
        |  maybe_extract_response(finish_request, [ReqData,_], _) -&gt;
<font color=red>     0..|      ReqData;</font>
        |  maybe_extract_response(finish_request, {_, ReqData, _}, _) -&gt;
<font color=red>     0..|      ReqData;</font>
        |  maybe_extract_response(_, _, R) -&gt;
<font color=red>     0..|      R.</font>
        |  
        |  base_decision_name(Decision) -&gt;
<font color=red>     0..|      [$v,$3|D] = atom_to_list(Decision), %% strip 'v3'</font>
<font color=red>     0..|      case lists:reverse(D) of</font>
        |          [A|RD] when A &gt;= $a, A =&lt; $z -&gt;
<font color=red>     0..|              lists:reverse(RD); %% strip 'b' off end of some</font>
        |          _ -&gt;
<font color=red>     0..|              D</font>
        |      end.
        |  
        |  encode_request(ReqData) when is_record(ReqData, wm_reqdata) -&gt;
<font color=red>     0..|      {struct, [{"method", atom_to_list(</font>
        |                             wrq:method(ReqData))},
        |                {"path", wrq:raw_path(ReqData)},
        |                {"headers", encode_headers(wrq:req_headers(ReqData))},
        |                {"body", case ReqData#wm_reqdata.req_body of
<font color=red>     0..|                             undefined -&gt; [];</font>
        |                             Body when is_atom(Body) -&gt;
<font color=red>     0..|                                 atom_to_list(Body);</font>
<font color=red>     0..|                             Body -&gt; lists:flatten(io_lib:format("~s", [Body]))</font>
        |                         end}]}.
        |  
        |  encode_response(ReqData) -&gt;
<font color=red>     0..|      {struct, [{"code", integer_to_list(</font>
        |                           wrq:response_code(ReqData))},
        |                {"headers", encode_headers(wrq:resp_headers(ReqData))},
        |                {"body", lists:flatten(io_lib:format("~s", [wrq:resp_body(ReqData)]))}]}.
        |  
        |  encode_headers(Headers) when is_list(Headers) -&gt;
<font color=red>     0..|      {struct, [ {N, V} || {N, V} &lt;- Headers ]};</font>
        |  encode_headers(Headers) -&gt;
<font color=red>     0..|      encode_headers(mochiweb_headers:to_list(Headers)).</font>
        |  
        |  encode_trace_part({Decision, Calls}) -&gt;
<font color=red>     0..|      {struct, [{"d", Decision},</font>
        |                {"calls",
<font color=red>     0..|                 {array, [ {struct,</font>
        |                            [{"module", Module},
        |                             {"function", Function},
        |                             {"input", encode_trace_io(Input)},
        |                             {"output", encode_trace_io(Output)}]}
        |                           || {Module, Function, Input, Output}
<font color=red>     0..|                                  &lt;- lists:reverse(Calls) ]}}]}.</font>
        |  
<font color=red>     0..|  encode_trace_io(wmtrace_null) -&gt; null;</font>
<font color=red>     0..|  encode_trace_io(wmtrace_not_exported) -&gt; "wmtrace_not_exported";</font>
        |  encode_trace_io(Data) -&gt;
<font color=red>     0..|      lists:flatten(io_lib:format("~p", [Data])).</font>
        |  
        |  %%
        |  %% HTML Building
        |  %%
        |  
        |  -define(TAG(T), T(Attrs, Content) -&gt;
        |                     tag(??T, Attrs, Content)).
        |  
<font color=red>     0..|  ?TAG(head).</font>
<font color=red>     0..|  ?TAG(script).</font>
<font color=red>     0..|  ?TAG(title).</font>
<font color=red>     0..|  ?TAG(body).</font>
<font color=red>     0..|  ?TAG(h1).</font>
<font color=red>     0..|  ?TAG(ul).</font>
<font color=red>     0..|  ?TAG(li).</font>
<font color=red>     0..|  ?TAG(a).</font>
<font color=red>     0..|  ?TAG(canvas).</font>
<font color=red>     0..|  ?TAG(select).</font>
<font color=red>     0..|  ?TAG(pre).</font>
<font color=red>     0..|  ?TAG(span).</font>
<font color=red>     0..|  ?TAG(button).</font>
        |  
        |  html(_Attrs, Content) -&gt;
<font color=red>     0..|      [&lt;&lt;"&lt;!DOCTYPE html PUBLIC \"-//W3C//DTD XHTML 1.0 Transitional//EN\" \"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd\"&gt;"&gt;&gt;,</font>
        |       &lt;&lt;"&lt;html xmlns=\"http://www.w3.org/1999/xhtml\" xml:lang=\"en\" lang=\"en\"&gt;"&gt;&gt;,
        |       Content,
        |       &lt;&lt;"&lt;/html&gt;"&gt;&gt;].
        |  
        |  divblock(Attrs, Content) -&gt;
<font color=red>     0..|      tag("div", Attrs, Content). %% div is a reserved word</font>
        |  
        |  linkblock(Attrs, Content) -&gt;
<font color=red>     0..|      tag("link", Attrs, Content). %% link is a reserved word</font>
        |  
        |  tag(Name, Attrs, Content) -&gt;
<font color=red>     0..|      ["&lt;",Name,</font>
<font color=red>     0..|       [ [" ",K,"=\"",V,"\""] || {K, V} &lt;- Attrs ],</font>
<font color=red>     0..|       if Content == empty -&gt; "/&gt;";</font>
        |          true -&gt;
<font color=red>     0..|               ["&gt;",</font>
        |                Content,
        |                "&lt;/",Name,"&gt;"]
        |       end].
</pre>
</body>
</html>
