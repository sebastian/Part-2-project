<html>
<head><title>.eunit/webmachine_mochiweb.COVER.html</title></head><body bgcolor=white text=black>
<pre>
File generated from /Users/seb/Documents/part2project/app/deps/webmachine/.eunit/webmachine_mochiweb.erl by COVER 2010-10-28 at 14:19:55

****************************************************************************

        |  %% @author Justin Sheehy &lt;justin@basho.com&gt;
        |  %% @author Andy Gross &lt;andy@basho.com&gt;
        |  %% @copyright 2007-2008 Basho Technologies
        |  %%
        |  %%    Licensed under the Apache License, Version 2.0 (the "License");
        |  %%    you may not use this file except in compliance with the License.
        |  %%    You may obtain a copy of the License at
        |  %%
        |  %%        http://www.apache.org/licenses/LICENSE-2.0
        |  %%
        |  %%    Unless required by applicable law or agreed to in writing, software
        |  %%    distributed under the License is distributed on an "AS IS" BASIS,
        |  %%    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
        |  %%    See the License for the specific language governing permissions and
        |  %%    limitations under the License.
        |  
        |  %% @doc Mochiweb interface for webmachine.
        |  -module(webmachine_mochiweb).
        |  -author('Justin Sheehy &lt;justin@basho.com&gt;').
        |  -author('Andy Gross &lt;andy@basho.com&gt;').
        |  -export([start/1, stop/0, loop/1]).
        |  
        |  start(Options) -&gt;
<font color=red>     0..|      {DispatchList, Options1} = get_option(dispatch, Options),</font>
<font color=red>     0..|      {ErrorHandler0, Options2} = get_option(error_handler, Options1),</font>
<font color=red>     0..|      {EnablePerfLog, Options3} = get_option(enable_perf_logger, Options2),</font>
<font color=red>     0..|      ErrorHandler = </font>
        |          case ErrorHandler0 of 
        |              undefined -&gt;
<font color=red>     0..|                  webmachine_error_handler;</font>
<font color=red>     0..|              EH -&gt; EH</font>
        |          end,
<font color=red>     0..|      {LogDir, Options4} = get_option(log_dir, Options3),</font>
<font color=red>     0..|      case whereis(webmachine_logger) of</font>
        |        undefined -&gt;
<font color=red>     0..|          webmachine_sup:start_logger(LogDir);</font>
        |        _ -&gt;
<font color=red>     0..|          ignore</font>
        |      end,
<font color=red>     0..|      case EnablePerfLog of</font>
        |          true -&gt;
<font color=red>     0..|            case whereis(webmachine_perf_logger) of</font>
        |              undefined -&gt;
<font color=red>     0..|                application:set_env(webmachine, enable_perf_logger, true),</font>
<font color=red>     0..|                webmachine_sup:start_perf_logger(LogDir);</font>
        |              _ -&gt;
<font color=red>     0..|                ignore</font>
        |            end;
        |          _ -&gt;
<font color=red>     0..|              ignore</font>
        |      end,
<font color=red>     0..|      {PName, Options5} = case get_option(name, Options4) of</font>
<font color=red>     0..|        {undefined, _} -&gt; {?MODULE, Options4};</font>
<font color=red>     0..|        {PN, O5} -&gt; {PN, O5}</font>
        |      end,
<font color=red>     0..|      application:set_env(webmachine, dispatch_list, DispatchList),</font>
<font color=red>     0..|      application:set_env(webmachine, error_handler, ErrorHandler),</font>
<font color=red>     0..|      mochiweb_http:start([{name, PName}, {loop, fun loop/1} | Options5]).</font>
        |  
        |  stop() -&gt;
<font color=red>     0..|      {registered_name, PName} = process_info(self(), registered_name),</font>
<font color=red>     0..|      mochiweb_http:stop(PName).</font>
        |  
        |  loop(MochiReq) -&gt;
<font color=red>     0..|      Req = webmachine:new_request(mochiweb, MochiReq),</font>
<font color=red>     0..|      {ok, DispatchList} = application:get_env(webmachine, dispatch_list),</font>
<font color=red>     0..|      Host = case host_headers(Req) of</font>
<font color=red>     0..|                 [H|_] -&gt; H;</font>
<font color=red>     0..|                 [] -&gt; []</font>
        |             end,
<font color=red>     0..|      {Path, _} = Req:path(),</font>
<font color=red>     0..|      case webmachine_dispatcher:dispatch(Host, Path, DispatchList) of</font>
        |          {no_dispatch_match, _UnmatchedHost, _UnmatchedPathTokens} -&gt;
<font color=red>     0..|              {ok, ErrorHandler} = application:get_env(webmachine, error_handler),</font>
<font color=red>     0..|              {ErrorHTML,ReqState1} = </font>
        |                  ErrorHandler:render_error(404, Req, {none, none, []}),
<font color=red>     0..|              Req1 = {webmachine_request,ReqState1},</font>
<font color=red>     0..|              {ok,ReqState2} = Req1:append_to_response_body(ErrorHTML),</font>
<font color=red>     0..|              Req2 = {webmachine_request,ReqState2},</font>
<font color=red>     0..|              {ok,ReqState3} = Req2:send_response(404),</font>
<font color=red>     0..|              Req3 = {webmachine_request,ReqState3},</font>
<font color=red>     0..|              {LogData,_ReqState4} = Req3:log_data(),</font>
<font color=red>     0..|              case application:get_env(webmachine,webmachine_logger_module) of</font>
        |                  {ok, LogModule} -&gt;
<font color=red>     0..|                      spawn(LogModule, log_access, [LogData]);</font>
<font color=red>     0..|                  _ -&gt; nop</font>
        |              end;
        |          {Mod, ModOpts, HostTokens, Port, PathTokens, Bindings,
        |           AppRoot, StringPath} -&gt;
<font color=red>     0..|              BootstrapResource = webmachine_resource:new(x,x,x,x),</font>
<font color=red>     0..|              {ok, Resource} = BootstrapResource:wrap(Mod, ModOpts),</font>
<font color=red>     0..|              {ok,RS1} = Req:load_dispatch_data(Bindings,HostTokens,Port,</font>
        |                                                PathTokens,AppRoot,StringPath),
<font color=red>     0..|              XReq1 = {webmachine_request,RS1},</font>
<font color=red>     0..|              {ok,RS2} = XReq1:set_metadata('resource_module', Mod),</font>
<font color=red>     0..|              try </font>
<font color=red>     0..|                  webmachine_decision_core:handle_request(Resource, RS2)</font>
        |              catch
        |                  error:_ -&gt; 
<font color=red>     0..|                      FailReq = {webmachine_request,RS2},</font>
<font color=red>     0..|                      {ok,RS3} = FailReq:send_response(500),</font>
<font color=red>     0..|                      PostFailReq = {webmachine_request,RS3},</font>
<font color=red>     0..|                      {LogData,_RS4} = PostFailReq:log_data(),</font>
<font color=red>     0..|                      case application:get_env(webmachine,</font>
        |                                               webmachine_logger_module) of
        |                          {ok, LogModule} -&gt;
<font color=red>     0..|                              spawn(LogModule, log_access, [LogData]);</font>
<font color=red>     0..|                          _ -&gt; nop</font>
        |                      end
        |              end
        |      end.
        |  
        |  get_option(Option, Options) -&gt;
<font color=red>     0..|      {proplists:get_value(Option, Options), proplists:delete(Option, Options)}.</font>
        |  
        |  host_headers(Req) -&gt;
<font color=red>     0..|      [ V || {V,_ReqState} &lt;- [Req:get_header_value(H)</font>
<font color=red>     0..|                               || H &lt;- ["x-forwarded-host",</font>
        |                                        "x-forwarded-server",
        |                                        "host"]],
<font color=red>     0..|             V /= undefined].</font>
</pre>
</body>
</html>
