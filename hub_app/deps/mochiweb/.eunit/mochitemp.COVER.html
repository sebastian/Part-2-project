<html>
<head><title>.eunit/mochitemp.COVER.html</title></head><body bgcolor=white text=black>
<pre>
File generated from /Users/seb/Documents/part2project/app/deps/mochiweb/.eunit/mochitemp.erl by COVER 2010-10-28 at 14:19:48

****************************************************************************

        |  %% @author Bob Ippolito &lt;bob@mochimedia.com&gt;
        |  %% @copyright 2010 Mochi Media, Inc.
        |  
        |  %% @doc Create temporary files and directories. Requires crypto to be started.
        |  
        |  -module(mochitemp).
        |  -export([gettempdir/0]).
        |  -export([mkdtemp/0, mkdtemp/3]).
        |  -export([rmtempdir/1]).
        |  %% -export([mkstemp/4]).
        |  -define(SAFE_CHARS, {$a, $b, $c, $d, $e, $f, $g, $h, $i, $j, $k, $l, $m,
        |                       $n, $o, $p, $q, $r, $s, $t, $u, $v, $w, $x, $y, $z,
        |                       $A, $B, $C, $D, $E, $F, $G, $H, $I, $J, $K, $L, $M,
        |                       $N, $O, $P, $Q, $R, $S, $T, $U, $V, $W, $X, $Y, $Z,
        |                       $0, $1, $2, $3, $4, $5, $6, $7, $8, $9, $_}).
        |  -define(TMP_MAX, 10000).
        |  
        |  -include_lib("kernel/include/file.hrl").
        |  
        |  %% TODO: An ugly wrapper over the mktemp tool with open_port and sadness?
        |  %%       We can't implement this race-free in Erlang without the ability
        |  %%       to issue O_CREAT|O_EXCL. I suppose we could hack something with
        |  %%       mkdtemp, del_dir, open.
        |  %% mkstemp(Suffix, Prefix, Dir, Options) -&gt;
        |  %%    ok.
        |  
        |  rmtempdir(Dir) -&gt;
     5..|      case file:del_dir(Dir) of
        |          {error, eexist} -&gt;
     3..|              ok = rmtempdirfiles(Dir),
     3..|              ok = file:del_dir(Dir);
        |          ok -&gt;
     2..|              ok
        |      end.
        |  
        |  rmtempdirfiles(Dir) -&gt;
     3..|      {ok, Files} = file:list_dir(Dir),
     3..|      ok = rmtempdirfiles(Dir, Files).
        |  
        |  rmtempdirfiles(_Dir, []) -&gt;
     3..|      ok;
        |  rmtempdirfiles(Dir, [Basename | Rest]) -&gt;
     4..|      Path = filename:join([Dir, Basename]),
     4..|      case filelib:is_dir(Path) of
        |          true -&gt;
     2..|              ok = rmtempdir(Path);
        |          false -&gt;
     2..|              ok = file:delete(Path)
        |      end,
     4..|      rmtempdirfiles(Dir, Rest).
        |  
        |  mkdtemp() -&gt;
     8..|      mkdtemp("", "tmp", gettempdir()).
        |  
        |  mkdtemp(Suffix, Prefix, Dir) -&gt;
     9..|      mkdtemp_n(rngpath_fun(Suffix, Prefix, Dir), ?TMP_MAX).
        |  
        |  
        |  
        |  mkdtemp_n(RngPath, 1) -&gt;
     4..|      make_dir(RngPath());
        |  mkdtemp_n(RngPath, N) -&gt;
    11..|      try make_dir(RngPath())
        |      catch throw:{error, eexist} -&gt;
     2..|              mkdtemp_n(RngPath, N - 1)
        |      end.
        |  
        |  make_dir(Path) -&gt;
    16..|      case file:make_dir(Path) of
        |          ok -&gt;
    10..|              ok;
        |          E={error, eexist} -&gt;
     6..|              throw(E)
        |      end,
        |      %% Small window for a race condition here because dir is created 777
    10..|      ok = file:write_file_info(Path, #file_info{mode=8#0700}),
    10..|      Path.
        |  
        |  rngpath_fun(Prefix, Suffix, Dir) -&gt;
     9..|      fun () -&gt;
     9..|              filename:join([Dir, Prefix ++ rngchars(6) ++ Suffix])
        |      end.
        |  
        |  rngchars(0) -&gt;
    11..|      "";
        |  rngchars(N) -&gt;
    64..|      [rngchar() | rngchars(N - 1)].
        |  
        |  rngchar() -&gt;
    64..|      rngchar(crypto:rand_uniform(0, tuple_size(?SAFE_CHARS))).
        |  
        |  rngchar(C) -&gt;
    67..|      element(1 + C, ?SAFE_CHARS).
        |  
        |  %% @spec gettempdir() -&gt; string()
        |  %% @doc Get a usable temporary directory using the first of these that is a directory:
        |  %%      $TMPDIR, $TMP, $TEMP, "/tmp", "/var/tmp", "/usr/tmp", ".".
        |  gettempdir() -&gt;
    10..|      gettempdir(gettempdir_checks(), fun normalize_dir/1).
        |  
        |  gettempdir_checks() -&gt;
    10..|      [{fun os:getenv/1, ["TMPDIR", "TMP", "TEMP"]},
        |       {fun gettempdir_identity/1, ["/tmp", "/var/tmp", "/usr/tmp"]},
        |       {fun gettempdir_cwd/1, [cwd]}].
        |  
        |  gettempdir_identity(L) -&gt;
     5..|      L.
        |  
        |  gettempdir_cwd(cwd) -&gt;
     1..|      {ok, L} = file:get_cwd(),
     1..|      L.
        |  
        |  gettempdir([{_F, []} | RestF], Normalize) -&gt;
     2..|      gettempdir(RestF, Normalize);
        |  gettempdir([{F, [L | RestL]} | RestF], Normalize) -&gt;
    17..|      case Normalize(F(L)) of
        |          false -&gt;
     3..|              gettempdir([{F, RestL} | RestF], Normalize);
        |          Dir -&gt;
    14..|              Dir
        |      end.
        |  
        |  normalize_dir(False) when False =:= false orelse False =:= "" -&gt;
        |      %% Erlang doesn't have an unsetenv, wtf.
     2..|      false;
        |  normalize_dir(L) -&gt;
    17..|      Dir = filename:absname(L),
    17..|      case filelib:is_dir(Dir) of
        |          false -&gt;
     1..|              false;
        |          true -&gt;
    16..|              Dir
        |      end.
        |  
        |  %%
        |  %% Tests
        |  %%
        |  -include_lib("eunit/include/eunit.hrl").
        |  -ifdef(TEST).
        |  pushenv(L) -&gt;
     1..|      [{K, os:getenv(K)} || K &lt;- L].
        |  popenv(L) -&gt;
     5..|      F = fun ({K, false}) -&gt;
        |                  %% Erlang doesn't have an unsetenv, wtf.
     8..|                  os:putenv(K, "");
        |              ({K, V}) -&gt;
     3..|                  os:putenv(K, V)
        |          end,
     5..|      lists:foreach(F, L).
        |  
        |  gettempdir_fallback_test() -&gt;
     1..|      ?assertEqual(
        |         "/",
        |         gettempdir([{fun gettempdir_identity/1, ["/--not-here--/"]},
        |                     {fun gettempdir_identity/1, ["/"]}],
     1..|                    fun normalize_dir/1)),
     1..|      ?assertEqual(
        |         "/",
        |         %% simulate a true os:getenv unset env
        |         gettempdir([{fun gettempdir_identity/1, [false]},
        |                     {fun gettempdir_identity/1, ["/"]}],
     1..|                    fun normalize_dir/1)),
     1..|      ok.
        |  
        |  gettempdir_identity_test() -&gt;
     1..|      ?assertEqual(
        |         "/",
     1..|         gettempdir([{fun gettempdir_identity/1, ["/"]}], fun normalize_dir/1)),
     1..|      ok.
        |  
        |  gettempdir_cwd_test() -&gt;
     1..|      {ok, Cwd} = file:get_cwd(),
     1..|      ?assertEqual(
        |         normalize_dir(Cwd),
     1..|         gettempdir([{fun gettempdir_cwd/1, [cwd]}], fun normalize_dir/1)),
     1..|      ok.
        |  
        |  rngchars_test() -&gt;
     1..|      crypto:start(),
     1..|      ?assertEqual(
        |         "",
     1..|         rngchars(0)),
     1..|      ?assertEqual(
        |         10,
     1..|         length(rngchars(10))),
     1..|      ok.
        |  
        |  rngchar_test() -&gt;
     1..|      ?assertEqual(
        |         $a,
     1..|         rngchar(0)),
     1..|      ?assertEqual(
        |         $A,
     1..|         rngchar(26)),
     1..|      ?assertEqual(
        |         $_,
     1..|         rngchar(62)),
     1..|      ok.
        |  
        |  mkdtemp_n_failonce_test() -&gt;
     1..|      crypto:start(),
     1..|      D = mkdtemp(),
     1..|      Path = filename:join([D, "testdir"]),
        |      %% Toggle the existence of a dir so that it fails
        |      %% the first time and succeeds the second.
     1..|      F = fun () -&gt;
     3..|                  case filelib:is_dir(Path) of
        |                      true -&gt;
     1..|                          file:del_dir(Path);
        |                      false -&gt;
     2..|                          file:make_dir(Path)
        |                  end,
     3..|                  Path
        |          end,
     1..|      try
        |          %% Fails the first time
     1..|          ?assertThrow(
     1..|             {error, eexist},
     1..|             mkdtemp_n(F, 1)),
        |          %% Reset state
     1..|          file:del_dir(Path),
        |          %% Succeeds the second time
     1..|          ?assertEqual(
        |             Path,
     1..|             mkdtemp_n(F, 2))
     1..|      after rmtempdir(D)
        |      end,
     1..|      ok.
        |  
        |  mkdtemp_n_fail_test() -&gt;
     1..|      {ok, Cwd} = file:get_cwd(),
     1..|      ?assertThrow(
     1..|         {error, eexist},
     1..|         mkdtemp_n(fun () -&gt; Cwd end, 1)),
     1..|      ?assertThrow(
     1..|         {error, eexist},
     1..|         mkdtemp_n(fun () -&gt; Cwd end, 2)),
     1..|      ok.
        |  
        |  make_dir_fail_test() -&gt;
     1..|      {ok, Cwd} = file:get_cwd(),
     1..|      ?assertThrow(
     1..|        {error, eexist},
     1..|        make_dir(Cwd)),
     1..|      ok.
        |  
        |  mkdtemp_test() -&gt;
     1..|      crypto:start(),
     1..|      D = mkdtemp(),
     1..|      ?assertEqual(
        |         true,
     1..|         filelib:is_dir(D)),
     1..|      ?assertEqual(
        |         ok,
     1..|         file:del_dir(D)),
     1..|      ok.
        |  
        |  rmtempdir_test() -&gt;
     1..|      crypto:start(),
     1..|      D1 = mkdtemp(),
     1..|      ?assertEqual(
        |         true,
     1..|         filelib:is_dir(D1)),
     1..|      ?assertEqual(
        |         ok,
     1..|         rmtempdir(D1)),
     1..|      D2 = mkdtemp(),
     1..|      ?assertEqual(
        |         true,
     1..|         filelib:is_dir(D2)),
     1..|      ok = file:write_file(filename:join([D2, "foo"]), &lt;&lt;"bytes"&gt;&gt;),
     1..|      D3 = mkdtemp("suffix", "prefix", D2),
     1..|      ?assertEqual(
        |         true,
     1..|         filelib:is_dir(D3)),
     1..|      ok = file:write_file(filename:join([D3, "foo"]), &lt;&lt;"bytes"&gt;&gt;),
     1..|      ?assertEqual(
        |         ok,
     1..|         rmtempdir(D2)),
     1..|      ?assertEqual(
        |         {error, enoent},
     1..|         file:consult(D3)),
     1..|      ?assertEqual(
        |         {error, enoent},
     1..|         file:consult(D2)),
     1..|      ok.
        |  
        |  gettempdir_env_test() -&gt;
     1..|      Env = pushenv(["TMPDIR", "TEMP", "TMP"]),
     1..|      FalseEnv = [{"TMPDIR", false}, {"TEMP", false}, {"TMP", false}],
     1..|      try
     1..|          popenv(FalseEnv),
     1..|          popenv([{"TMPDIR", "/"}]),
     1..|          ?assertEqual(
        |             "/",
     1..|             os:getenv("TMPDIR")),
     1..|          ?assertEqual(
        |             "/",
     1..|             gettempdir()),
     1..|          {ok, Cwd} = file:get_cwd(),
     1..|          popenv(FalseEnv),
     1..|          popenv([{"TMP", Cwd}]),
     1..|          ?assertEqual(
        |             normalize_dir(Cwd),
     1..|             gettempdir())
     1..|      after popenv(Env)
        |      end,
     1..|      ok.
        |  
        |  -endif.
</pre>
</body>
</html>
