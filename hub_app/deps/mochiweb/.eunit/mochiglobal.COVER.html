<html>
<head><title>.eunit/mochiglobal.COVER.html</title></head><body bgcolor=white text=black>
<pre>
File generated from /Users/seb/Documents/part2project/app/deps/mochiweb/.eunit/mochiglobal.erl by COVER 2010-10-28 at 14:19:48

****************************************************************************

        |  %% @author Bob Ippolito &lt;bob@mochimedia.com&gt;
        |  %% @copyright 2010 Mochi Media, Inc.
        |  %% @doc Abuse module constant pools as a "read-only shared heap" (since erts 5.6)
        |  %%      &lt;a href="http://www.erlang.org/pipermail/erlang-questions/2009-March/042503.html"&gt;[1]&lt;/a&gt;.
        |  -module(mochiglobal).
        |  -author("Bob Ippolito &lt;bob@mochimedia.com&gt;").
        |  -export([get/1, get/2, put/2, delete/1]).
        |  
        |  -spec get(atom()) -&gt; any() | undefined.
        |  %% @equiv get(K, undefined)
        |  get(K) -&gt;
     2..|      get(K, undefined).
        |  
        |  -spec get(atom(), T) -&gt; any() | T.
        |  %% @doc Get the term for K or return Default.
        |  get(K, Default) -&gt;
     5..|      get(K, Default, key_to_module(K)).
        |  
        |  get(_K, Default, Mod) -&gt;
     5..|      try Mod:term()
        |      catch error:undef -&gt;
     3..|              Default
        |      end.
        |  
        |  -spec put(atom(), any()) -&gt; ok.
        |  %% @doc Store term V at K, replaces an existing term if present.
        |  put(K, V) -&gt;
     2..|      put(K, V, key_to_module(K)).
        |  
        |  put(_K, V, Mod) -&gt;
     2..|      Bin = compile(Mod, V),
     2..|      code:purge(Mod),
     2..|      code:load_binary(Mod, atom_to_list(Mod) ++ ".erl", Bin),
     2..|      ok.
        |  
        |  -spec delete(atom()) -&gt; boolean().
        |  %% @doc Delete term stored at K, no-op if non-existent.
        |  delete(K) -&gt;
     2..|      delete(K, key_to_module(K)).
        |  
        |  delete(_K, Mod) -&gt;
     2..|      code:purge(Mod),
     2..|      code:delete(Mod).
        |  
        |  -spec key_to_module(atom()) -&gt; atom().
        |  key_to_module(K) -&gt;
     9..|      list_to_atom("mochiglobal:" ++ atom_to_list(K)).
        |  
        |  -spec compile(atom(), any()) -&gt; binary().
        |  compile(Module, T) -&gt;
     2..|      {ok, Module, Bin} = compile:forms(forms(Module, T),
        |                                        [verbose, report_errors]),
     2..|      Bin.
        |  
        |  -spec forms(atom(), any()) -&gt; [erl_syntax:syntaxTree()].
        |  forms(Module, T) -&gt;
     2..|      [erl_syntax:revert(X) || X &lt;- term_to_abstract(Module, term, T)].
        |  
        |  -spec term_to_abstract(atom(), atom(), any()) -&gt; [erl_syntax:syntaxTree()].
        |  term_to_abstract(Module, Getter, T) -&gt;
     2..|      [%% -module(Module).
        |       erl_syntax:attribute(
        |         erl_syntax:atom(module),
        |         [erl_syntax:atom(Module)]),
        |       %% -export([Getter/0]).
        |       erl_syntax:attribute(
        |         erl_syntax:atom(export),
        |         [erl_syntax:list(
        |           [erl_syntax:arity_qualifier(
        |              erl_syntax:atom(Getter),
        |              erl_syntax:integer(0))])]),
        |       %% Getter() -&gt; T.
        |       erl_syntax:function(
        |         erl_syntax:atom(Getter),
        |         [erl_syntax:clause([], none, [erl_syntax:abstract(T)])])].
        |  
        |  %%
        |  %% Tests
        |  %%
        |  -include_lib("eunit/include/eunit.hrl").
        |  -ifdef(TEST).
        |  get_put_delete_test() -&gt;
     1..|      K = '$$test$$mochiglobal',
     1..|      delete(K),
     1..|      ?assertEqual(
        |         bar,
     1..|         get(K, bar)),
     1..|      try
     1..|          ?MODULE:put(K, baz),
     1..|          ?assertEqual(
        |             baz,
     1..|             get(K, bar)),
     1..|          ?MODULE:put(K, wibble),
     1..|          ?assertEqual(
        |             wibble,
     1..|             ?MODULE:get(K))
        |      after
     1..|          delete(K)
        |      end,
     1..|      ?assertEqual(
        |         bar,
     1..|         get(K, bar)),
     1..|      ?assertEqual(
        |         undefined,
     1..|         ?MODULE:get(K)),
     1..|      ok.
        |  -endif.
</pre>
</body>
</html>
