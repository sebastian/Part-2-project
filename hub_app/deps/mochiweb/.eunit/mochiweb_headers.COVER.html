<html>
<head><title>.eunit/mochiweb_headers.COVER.html</title></head><body bgcolor=white text=black>
<pre>
File generated from /Users/seb/Documents/part2project/app/deps/mochiweb/.eunit/mochiweb_headers.erl by COVER 2010-10-28 at 14:19:49

****************************************************************************

        |  %% @author Bob Ippolito &lt;bob@mochimedia.com&gt;
        |  %% @copyright 2007 Mochi Media, Inc.
        |  
        |  %% @doc Case preserving (but case insensitive) HTTP Header dictionary.
        |  
        |  -module(mochiweb_headers).
        |  -author('bob@mochimedia.com').
        |  -export([empty/0, from_list/1, insert/3, enter/3, get_value/2, lookup/2]).
        |  -export([delete_any/2, get_primary_value/2]).
        |  -export([default/3, enter_from_list/2, default_from_list/2]).
        |  -export([to_list/1, make/1]).
        |  -export([from_binary/1]).
        |  
        |  %% @type headers().
        |  %% @type key() = atom() | binary() | string().
        |  %% @type value() = atom() | binary() | string() | integer().
        |  
        |  %% @spec empty() -&gt; headers()
        |  %% @doc Create an empty headers structure.
        |  empty() -&gt;
   877..|      gb_trees:empty().
        |  
        |  %% @spec make(headers() | [{key(), value()}]) -&gt; headers()
        |  %% @doc Construct a headers() from the given list.
        |  make(L) when is_list(L) -&gt;
   877..|      from_list(L);
        |  %% assume a tuple is already mochiweb_headers.
        |  make(T) when is_tuple(T) -&gt;
  1049..|      T.
        |  
        |  %% @spec from_binary(iolist()) -&gt; headers()
        |  %% @doc Transforms a raw HTTP header into a mochiweb headers structure.
        |  %%
        |  %%      The given raw HTTP header can be one of the following:
        |  %%
        |  %%      1) A string or a binary representing a full HTTP header ending with
        |  %%         double CRLF.
        |  %%         Examples:
        |  %%         ```
        |  %%         "Content-Length: 47\r\nContent-Type: text/plain\r\n\r\n"
        |  %%         &lt;&lt;"Content-Length: 47\r\nContent-Type: text/plain\r\n\r\n"&gt;&gt;'''
        |  %%
        |  %%      2) A list of binaries or strings where each element represents a raw
        |  %%         HTTP header line ending with a single CRLF.
        |  %%         Examples:
        |  %%         ```
        |  %%         [&lt;&lt;"Content-Length: 47\r\n"&gt;&gt;, &lt;&lt;"Content-Type: text/plain\r\n"&gt;&gt;]
        |  %%         ["Content-Length: 47\r\n", "Content-Type: text/plain\r\n"]
        |  %%         ["Content-Length: 47\r\n", &lt;&lt;"Content-Type: text/plain\r\n"&gt;&gt;]'''
        |  %%
        |  from_binary(RawHttpHeader) when is_binary(RawHttpHeader) -&gt;
    14..|      from_binary(RawHttpHeader, []);
        |  from_binary(RawHttpHeaderList) -&gt;
     9..|      from_binary(list_to_binary([RawHttpHeaderList, "\r\n"])).
        |  
        |  from_binary(RawHttpHeader, Acc) -&gt;
    24..|      case erlang:decode_packet(httph, RawHttpHeader, []) of
        |          {ok, {http_header, _, H, _, V}, Rest} -&gt;
    10..|              from_binary(Rest, [{H, V} | Acc]);
        |          _ -&gt;
    14..|              make(Acc)
        |      end.
        |  
        |  %% @spec from_list([{key(), value()}]) -&gt; headers()
        |  %% @doc Construct a headers() from the given list.
        |  from_list(List) -&gt;
   877..|      lists:foldl(fun ({K, V}, T) -&gt; insert(K, V, T) end, empty(), List).
        |  
        |  %% @spec enter_from_list([{key(), value()}], headers()) -&gt; headers()
        |  %% @doc Insert pairs into the headers, replace any values for existing keys.
        |  enter_from_list(List, T) -&gt;
     2..|      lists:foldl(fun ({K, V}, T1) -&gt; enter(K, V, T1) end, T, List).
        |  
        |  %% @spec default_from_list([{key(), value()}], headers()) -&gt; headers()
        |  %% @doc Insert pairs into the headers for keys that do not already exist.
        |  default_from_list(List, T) -&gt;
   422..|      lists:foldl(fun ({K, V}, T1) -&gt; default(K, V, T1) end, T, List).
        |  
        |  %% @spec to_list(headers()) -&gt; [{key(), string()}]
        |  %% @doc Return the contents of the headers. The keys will be the exact key
        |  %%      that was first inserted (e.g. may be an atom or binary, case is
        |  %%      preserved).
        |  to_list(T) -&gt;
   440..|      F = fun ({K, {array, L}}, Acc) -&gt;
     2..|                  L1 = lists:reverse(L),
     2..|                  lists:foldl(fun (V, Acc1) -&gt; [{K, V} | Acc1] end, Acc, L1);
        |              (Pair, Acc) -&gt;
  1694..|                  [Pair | Acc]
        |          end,
   440..|      lists:reverse(lists:foldl(F, [], gb_trees:values(T))).
        |  
        |  %% @spec get_value(key(), headers()) -&gt; string() | undefined
        |  %% @doc Return the value of the given header using a case insensitive search.
        |  %%      undefined will be returned for keys that are not present.
        |  get_value(K, T) -&gt;
  1710..|      case lookup(K, T) of
        |          {value, {_, V}} -&gt;
   268..|              expand(V);
        |          none -&gt;
  1442..|              undefined
        |      end.
        |  
        |  %% @spec get_primary_value(key(), headers()) -&gt; string() | undefined
        |  %% @doc Return the value of the given header up to the first semicolon using
        |  %%      a case insensitive search. undefined will be returned for keys
        |  %%      that are not present.
        |  get_primary_value(K, T) -&gt;
     4..|      case get_value(K, T) of
        |          undefined -&gt;
     1..|              undefined;
        |          V -&gt;
     3..|              lists:takewhile(fun (C) -&gt; C =/= $; end, V)
        |      end.
        |  
        |  %% @spec lookup(key(), headers()) -&gt; {value, {key(), string()}} | none
        |  %% @doc Return the case preserved key and value for the given header using
        |  %%      a case insensitive search. none will be returned for keys that are
        |  %%      not present.
        |  lookup(K, T) -&gt;
  1712..|      case gb_trees:lookup(normalize(K), T) of
        |          {value, {K0, V}} -&gt;
   269..|              {value, {K0, expand(V)}};
        |          none -&gt;
  1443..|              none
        |      end.
        |  
        |  %% @spec default(key(), value(), headers()) -&gt; headers()
        |  %% @doc Insert the pair into the headers if it does not already exist.
        |  default(K, V, T) -&gt;
   842..|      K1 = normalize(K),
   842..|      V1 = any_to_list(V),
   842..|      try gb_trees:insert(K1, {K, V1}, T)
        |      catch
        |          error:{key_exists, _} -&gt;
     1..|              T
        |      end.
        |  
        |  %% @spec enter(key(), value(), headers()) -&gt; headers()
        |  %% @doc Insert the pair into the headers, replacing any pre-existing key.
        |  enter(K, V, T) -&gt;
   630..|      K1 = normalize(K),
   630..|      V1 = any_to_list(V),
   630..|      gb_trees:enter(K1, {K, V1}, T).
        |  
        |  %% @spec insert(key(), value(), headers()) -&gt; headers()
        |  %% @doc Insert the pair into the headers, merging with any pre-existing key.
        |  %%      A merge is done with Value = V0 ++ ", " ++ V1.
        |  insert(K, V, T) -&gt;
  1129..|      K1 = normalize(K),
  1129..|      V1 = any_to_list(V),
  1129..|      try gb_trees:insert(K1, {K, V1}, T)
        |      catch
        |          error:{key_exists, _} -&gt;
     5..|              {K0, V0} = gb_trees:get(K1, T),
     5..|              V2 = merge(K1, V1, V0),
     5..|              gb_trees:update(K1, {K0, V2}, T)
        |      end.
        |  
        |  %% @spec delete_any(key(), headers()) -&gt; headers()
        |  %% @doc Delete the header corresponding to key if it is present.
        |  delete_any(K, T) -&gt;
     2..|      K1 = normalize(K),
     2..|      gb_trees:delete_any(K1, T).
        |  
        |  %% Internal API
        |  
        |  expand({array, L}) -&gt;
     2..|      mochiweb_util:join(lists:reverse(L), ", ");
        |  expand(V) -&gt;
   535..|      V.
        |  
        |  merge("set-cookie", V1, {array, L}) -&gt;
     1..|      {array, [V1 | L]};
        |  merge("set-cookie", V1, V0) -&gt;
     2..|      {array, [V1, V0]};
        |  merge(_, V1, V0) -&gt;
     2..|      V0 ++ ", " ++ V1.
        |  
        |  normalize(K) when is_list(K) -&gt;
  4315..|      string:to_lower(K);
        |  normalize(K) when is_atom(K) -&gt;
  1092..|      normalize(atom_to_list(K));
        |  normalize(K) when is_binary(K) -&gt;
     1..|      normalize(binary_to_list(K)).
        |  
        |  any_to_list(V) when is_list(V) -&gt;
  2150..|      V;
        |  any_to_list(V) when is_atom(V) -&gt;
    13..|      atom_to_list(V);
        |  any_to_list(V) when is_binary(V) -&gt;
     1..|      binary_to_list(V);
        |  any_to_list(V) when is_integer(V) -&gt;
   437..|      integer_to_list(V).
        |  
        |  %%
        |  %% Tests.
        |  %%
        |  -include_lib("eunit/include/eunit.hrl").
        |  -ifdef(TEST).
        |  
        |  make_test() -&gt;
     1..|      Identity = make([{hdr, foo}]),
     1..|      ?assertEqual(
        |         Identity,
     1..|         make(Identity)).
        |  
        |  enter_from_list_test() -&gt;
     1..|      H = make([{hdr, foo}]),
     1..|      ?assertEqual(
        |         [{baz, "wibble"}, {hdr, "foo"}],
     1..|         to_list(enter_from_list([{baz, wibble}], H))),
     1..|      ?assertEqual(
        |         [{hdr, "bar"}],
     1..|         to_list(enter_from_list([{hdr, bar}], H))),
     1..|      ok.
        |  
        |  default_from_list_test() -&gt;
     1..|      H = make([{hdr, foo}]),
     1..|      ?assertEqual(
        |         [{baz, "wibble"}, {hdr, "foo"}],
     1..|         to_list(default_from_list([{baz, wibble}], H))),
     1..|      ?assertEqual(
        |         [{hdr, "foo"}],
     1..|         to_list(default_from_list([{hdr, bar}], H))),
     1..|      ok.
        |  
        |  get_primary_value_test() -&gt;
     1..|      H = make([{hdr, foo}, {baz, &lt;&lt;"wibble;taco"&gt;&gt;}]),
     1..|      ?assertEqual(
        |         "foo",
     1..|         get_primary_value(hdr, H)),
     1..|      ?assertEqual(
        |         undefined,
     1..|         get_primary_value(bar, H)),
     1..|      ?assertEqual(
        |         "wibble",
     1..|         get_primary_value(&lt;&lt;"baz"&gt;&gt;, H)),
     1..|      ok.
        |  
        |  set_cookie_test() -&gt;
     1..|      H = make([{"set-cookie", foo}, {"set-cookie", bar}, {"set-cookie", baz}]),
     1..|      ?assertEqual(
        |         [{"set-cookie", "foo"}, {"set-cookie", "bar"}, {"set-cookie", "baz"}],
     1..|         to_list(H)),
     1..|      ok.
        |  
        |  headers_test() -&gt;
     1..|      H = ?MODULE:make([{hdr, foo}, {"Hdr", "bar"}, {'Hdr', 2}]),
     1..|      [{hdr, "foo, bar, 2"}] = ?MODULE:to_list(H),
     1..|      H1 = ?MODULE:insert(taco, grande, H),
     1..|      [{hdr, "foo, bar, 2"}, {taco, "grande"}] = ?MODULE:to_list(H1),
     1..|      H2 = ?MODULE:make([{"Set-Cookie", "foo"}]),
     1..|      [{"Set-Cookie", "foo"}] = ?MODULE:to_list(H2),
     1..|      H3 = ?MODULE:insert("Set-Cookie", "bar", H2),
     1..|      [{"Set-Cookie", "foo"}, {"Set-Cookie", "bar"}] = ?MODULE:to_list(H3),
     1..|      "foo, bar" = ?MODULE:get_value("set-cookie", H3),
     1..|      {value, {"Set-Cookie", "foo, bar"}} = ?MODULE:lookup("set-cookie", H3),
     1..|      undefined = ?MODULE:get_value("shibby", H3),
     1..|      none = ?MODULE:lookup("shibby", H3),
     1..|      H4 = ?MODULE:insert("content-type",
        |                          "application/x-www-form-urlencoded; charset=utf8",
        |                          H3),
     1..|      "application/x-www-form-urlencoded" = ?MODULE:get_primary_value(
        |                                               "content-type", H4),
     1..|      H4 = ?MODULE:delete_any("nonexistent-header", H4),
     1..|      H3 = ?MODULE:delete_any("content-type", H4),
     1..|      HB = &lt;&lt;"Content-Length: 47\r\nContent-Type: text/plain\r\n\r\n"&gt;&gt;,
     1..|      H_HB = ?MODULE:from_binary(HB),
     1..|      H_HB = ?MODULE:from_binary(binary_to_list(HB)),
     1..|      "47" = ?MODULE:get_value("Content-Length", H_HB),
     1..|      "text/plain" = ?MODULE:get_value("Content-Type", H_HB),
     1..|      L_H_HB = ?MODULE:to_list(H_HB),
     1..|      2 = length(L_H_HB),
     1..|      true = lists:member({'Content-Length', "47"}, L_H_HB),
     1..|      true = lists:member({'Content-Type', "text/plain"}, L_H_HB),
     1..|      HL = [ &lt;&lt;"Content-Length: 47\r\n"&gt;&gt;, &lt;&lt;"Content-Type: text/plain\r\n"&gt;&gt; ],
     1..|      HL2 = [ "Content-Length: 47\r\n", &lt;&lt;"Content-Type: text/plain\r\n"&gt;&gt; ],
     1..|      HL3 = [ &lt;&lt;"Content-Length: 47\r\n"&gt;&gt;, "Content-Type: text/plain\r\n" ],
     1..|      H_HL = ?MODULE:from_binary(HL),
     1..|      H_HL = ?MODULE:from_binary(HL2),
     1..|      H_HL = ?MODULE:from_binary(HL3),
     1..|      "47" = ?MODULE:get_value("Content-Length", H_HL),
     1..|      "text/plain" = ?MODULE:get_value("Content-Type", H_HL),
     1..|      L_H_HL = ?MODULE:to_list(H_HL),
     1..|      2 = length(L_H_HL),
     1..|      true = lists:member({'Content-Length', "47"}, L_H_HL),
     1..|      true = lists:member({'Content-Type', "text/plain"}, L_H_HL),
     1..|      [] = ?MODULE:to_list(?MODULE:from_binary(&lt;&lt;&gt;&gt;)),
     1..|      [] = ?MODULE:to_list(?MODULE:from_binary(&lt;&lt;""&gt;&gt;)),
     1..|      [] = ?MODULE:to_list(?MODULE:from_binary(&lt;&lt;"\r\n"&gt;&gt;)),
     1..|      [] = ?MODULE:to_list(?MODULE:from_binary(&lt;&lt;"\r\n\r\n"&gt;&gt;)),
     1..|      [] = ?MODULE:to_list(?MODULE:from_binary("")),
     1..|      [] = ?MODULE:to_list(?MODULE:from_binary([&lt;&lt;&gt;&gt;])),
     1..|      [] = ?MODULE:to_list(?MODULE:from_binary([&lt;&lt;""&gt;&gt;])),
     1..|      [] = ?MODULE:to_list(?MODULE:from_binary([&lt;&lt;"\r\n"&gt;&gt;])),
     1..|      [] = ?MODULE:to_list(?MODULE:from_binary([&lt;&lt;"\r\n\r\n"&gt;&gt;])),
     1..|      ok.
        |  
        |  -endif.
</pre>
</body>
</html>
