<html>
<head><title>.eunit/mochiweb_http.COVER.html</title></head><body bgcolor=white text=black>
<pre>
File generated from /Users/seb/Documents/part2project/app/deps/mochiweb/.eunit/mochiweb_http.erl by COVER 2010-10-28 at 14:19:49

****************************************************************************

        |  %% @author Bob Ippolito &lt;bob@mochimedia.com&gt;
        |  %% @copyright 2007 Mochi Media, Inc.
        |  
        |  %% @doc HTTP server.
        |  
        |  -module(mochiweb_http).
        |  -author('bob@mochimedia.com').
        |  -export([start/0, start/1, stop/0, stop/1]).
        |  -export([loop/2, default_body/1]).
        |  -export([after_response/2, reentry/1]).
        |  -export([parse_range_request/1, range_skip_length/2]).
        |  
        |  -define(REQUEST_RECV_TIMEOUT, 300000).   % timeout waiting for request line
        |  -define(HEADERS_RECV_TIMEOUT, 30000). % timeout waiting for headers
        |  
        |  -define(MAX_HEADERS, 1000).
        |  -define(DEFAULTS, [{name, ?MODULE},
        |                     {port, 8888}]).
        |  
        |  parse_options(Options) -&gt;
    16..|      {loop, HttpLoop} = proplists:lookup(loop, Options),
    16..|      Loop = fun (S) -&gt;
    16..|                     ?MODULE:loop(S, HttpLoop)
        |             end,
    16..|      Options1 = [{loop, Loop} | proplists:delete(loop, Options)],
    16..|      mochilists:set_defaults(?DEFAULTS, Options1).
        |  
        |  stop() -&gt;
<font color=red>     0..|      mochiweb_socket_server:stop(?MODULE).</font>
        |  
        |  stop(Name) -&gt;
    16..|      mochiweb_socket_server:stop(Name).
        |  
        |  start() -&gt;
<font color=red>     0..|      start([{ip, "127.0.0.1"},</font>
        |             {loop, {?MODULE, default_body}}]).
        |  
        |  start(Options) -&gt;
    16..|      mochiweb_socket_server:start(parse_options(Options)).
        |  
        |  frm(Body) -&gt;
<font color=red>     0..|      ["&lt;html&gt;&lt;head&gt;&lt;/head&gt;&lt;body&gt;"</font>
        |       "&lt;form method=\"POST\"&gt;"
        |       "&lt;input type=\"hidden\" value=\"message\" name=\"hidden\"/&gt;"
        |       "&lt;input type=\"submit\" value=\"regular POST\"&gt;"
        |       "&lt;/form&gt;"
        |       "&lt;br /&gt;"
        |       "&lt;form method=\"POST\" enctype=\"multipart/form-data\""
        |       " action=\"/multipart\"&gt;"
        |       "&lt;input type=\"hidden\" value=\"multipart message\" name=\"hidden\"/&gt;"
        |       "&lt;input type=\"file\" name=\"file\"/&gt;"
        |       "&lt;input type=\"submit\" value=\"multipart POST\" /&gt;"
        |       "&lt;/form&gt;"
        |       "&lt;pre&gt;", Body, "&lt;/pre&gt;"
        |       "&lt;/body&gt;&lt;/html&gt;"].
        |  
        |  default_body(Req, M, "/chunked") when M =:= 'GET'; M =:= 'HEAD' -&gt;
<font color=red>     0..|      Res = Req:ok({"text/plain", [], chunked}),</font>
<font color=red>     0..|      Res:write_chunk("First chunk\r\n"),</font>
<font color=red>     0..|      timer:sleep(5000),</font>
<font color=red>     0..|      Res:write_chunk("Last chunk\r\n"),</font>
<font color=red>     0..|      Res:write_chunk("");</font>
        |  default_body(Req, M, _Path) when M =:= 'GET'; M =:= 'HEAD' -&gt;
<font color=red>     0..|      Body = io_lib:format("~p~n", [[{parse_qs, Req:parse_qs()},</font>
        |                                     {parse_cookie, Req:parse_cookie()},
        |                                     Req:dump()]]),
<font color=red>     0..|      Req:ok({"text/html",</font>
        |              [mochiweb_cookies:cookie("mochiweb_http", "test_cookie")],
        |              frm(Body)});
        |  default_body(Req, 'POST', "/multipart") -&gt;
<font color=red>     0..|      Body = io_lib:format("~p~n", [[{parse_qs, Req:parse_qs()},</font>
        |                                     {parse_cookie, Req:parse_cookie()},
        |                                     {body, Req:recv_body()},
        |                                     Req:dump()]]),
<font color=red>     0..|      Req:ok({"text/html", [], frm(Body)});</font>
        |  default_body(Req, 'POST', _Path) -&gt;
<font color=red>     0..|      Body = io_lib:format("~p~n", [[{parse_qs, Req:parse_qs()},</font>
        |                                     {parse_cookie, Req:parse_cookie()},
        |                                     {parse_post, Req:parse_post()},
        |                                     Req:dump()]]),
<font color=red>     0..|      Req:ok({"text/html", [], frm(Body)});</font>
        |  default_body(Req, _Method, _Path) -&gt;
<font color=red>     0..|      Req:respond({501, [], []}).</font>
        |  
        |  default_body(Req) -&gt;
<font color=red>     0..|      default_body(Req, Req:get(method), Req:get(path)).</font>
        |  
        |  loop(Socket, Body) -&gt;
   420..|      mochiweb_socket:setopts(Socket, [{packet, http}]),
   420..|      request(Socket, Body).
        |  
        |  request(Socket, Body) -&gt;
   420..|      case mochiweb_socket:recv(Socket, 0, ?REQUEST_RECV_TIMEOUT) of
        |          {ok, {http_request, Method, Path, Version}} -&gt;
   420..|              mochiweb_socket:setopts(Socket, [{packet, httph}]),
   420..|              headers(Socket, {Method, Path, Version}, [], Body, 0);
        |          {error, {http_error, "\r\n"}} -&gt;
<font color=red>     0..|              request(Socket, Body);</font>
        |          {error, {http_error, "\n"}} -&gt;
<font color=red>     0..|              request(Socket, Body);</font>
        |          {error, closed} -&gt;
<font color=red>     0..|              mochiweb_socket:close(Socket),</font>
<font color=red>     0..|              exit(normal);</font>
        |          {error, timeout} -&gt;
<font color=red>     0..|              mochiweb_socket:close(Socket),</font>
<font color=red>     0..|              exit(normal);</font>
        |          _Other -&gt;
<font color=red>     0..|              handle_invalid_request(Socket)</font>
        |      end.
        |  
        |  reentry(Body) -&gt;
<font color=red>     0..|      fun (Req) -&gt;</font>
<font color=red>     0..|              ?MODULE:after_response(Body, Req)</font>
        |      end.
        |  
        |  headers(Socket, Request, Headers, _Body, ?MAX_HEADERS) -&gt;
        |      %% Too many headers sent, bad request.
<font color=red>     0..|      mochiweb_socket:setopts(Socket, [{packet, raw}]),</font>
<font color=red>     0..|      handle_invalid_request(Socket, Request, Headers);</font>
        |  headers(Socket, Request, Headers, Body, HeaderCount) -&gt;
  1280..|      case mochiweb_socket:recv(Socket, 0, ?HEADERS_RECV_TIMEOUT) of
        |          {ok, http_eoh} -&gt;
   420..|              mochiweb_socket:setopts(Socket, [{packet, raw}]),
   420..|              Req = mochiweb:new_request({Socket, Request,
        |                                          lists:reverse(Headers)}),
   420..|              call_body(Body, Req),
   420..|              ?MODULE:after_response(Body, Req);
        |          {ok, {http_header, _, Name, _, Value}} -&gt;
   860..|              headers(Socket, Request, [{Name, Value} | Headers], Body,
        |                      1 + HeaderCount);
        |          {error, closed} -&gt;
<font color=red>     0..|              mochiweb_socket:close(Socket),</font>
<font color=red>     0..|              exit(normal);</font>
        |          _Other -&gt;
<font color=red>     0..|              handle_invalid_request(Socket, Request, Headers)</font>
        |      end.
        |  
        |  call_body({M, F}, Req) -&gt;
<font color=red>     0..|      M:F(Req);</font>
        |  call_body(Body, Req) -&gt;
   420..|      Body(Req).
        |  
        |  handle_invalid_request(Socket) -&gt;
<font color=red>     0..|      handle_invalid_request(Socket, {'GET', {abs_path, "/"}, {0,9}}, []).</font>
        |  
        |  handle_invalid_request(Socket, Request, RevHeaders) -&gt;
<font color=red>     0..|      mochiweb_socket:setopts(Socket, [{packet, raw}]),</font>
<font color=red>     0..|      Req = mochiweb:new_request({Socket, Request,</font>
        |                                  lists:reverse(RevHeaders)}),
<font color=red>     0..|      Req:respond({400, [], []}),</font>
<font color=red>     0..|      mochiweb_socket:close(Socket),</font>
<font color=red>     0..|      exit(normal).</font>
        |  
        |  after_response(Body, Req) -&gt;
   420..|      Socket = Req:get(socket),
   420..|      case Req:should_close() of
        |          true -&gt;
    16..|              mochiweb_socket:close(Socket),
    16..|              exit(normal);
        |          false -&gt;
   404..|              Req:cleanup(),
   404..|              ?MODULE:loop(Socket, Body)
        |      end.
        |  
        |  parse_range_request("bytes=0-") -&gt;
     1..|      undefined;
        |  parse_range_request(RawRange) when is_list(RawRange) -&gt;
     9..|      try
     9..|          "bytes=" ++ RangeString = RawRange,
     7..|          Ranges = string:tokens(RangeString, ","),
     7..|          lists:map(fun ("-" ++ V)  -&gt;
     3..|                            {none, list_to_integer(V)};
        |                        (R) -&gt;
     7..|                            case string:tokens(R, "-") of
        |                                [S1, S2] -&gt;
     5..|                                    {list_to_integer(S1), list_to_integer(S2)};
        |                                [S] -&gt;
     2..|                                    {list_to_integer(S), none}
        |                            end
        |                    end,
        |                    Ranges)
        |      catch
        |          _:_ -&gt;
     3..|              fail
        |      end.
        |  
        |  range_skip_length(Spec, Size) -&gt;
    16..|      case Spec of
        |          {none, R} when R =&lt; Size, R &gt;= 0 -&gt;
     3..|              {Size - R, R};
        |          {none, _OutOfRange} -&gt;
     2..|              {0, Size};
        |          {R, none} when R &gt;= 0, R &lt; Size -&gt;
     3..|              {R, Size - R};
        |          {_OutOfRange, none} -&gt;
     2..|              invalid_range;
        |          {Start, End} when 0 =&lt; Start, Start =&lt; End, End &lt; Size -&gt;
     2..|              {Start, End - Start + 1};
        |          {_OutOfRange, _End} -&gt;
     4..|              invalid_range
        |      end.
        |  
        |  %%
        |  %% Tests
        |  %%
        |  -include_lib("eunit/include/eunit.hrl").
        |  -ifdef(TEST).
        |  
        |  range_test() -&gt;
        |      %% valid, single ranges
     1..|      ?assertEqual([{20, 30}], parse_range_request("bytes=20-30")),
     1..|      ?assertEqual([{20, none}], parse_range_request("bytes=20-")),
     1..|      ?assertEqual([{none, 20}], parse_range_request("bytes=-20")),
        |  
        |      %% trivial single range
     1..|      ?assertEqual(undefined, parse_range_request("bytes=0-")),
        |  
        |      %% invalid, single ranges
     1..|      ?assertEqual(fail, parse_range_request("")),
     1..|      ?assertEqual(fail, parse_range_request("garbage")),
     1..|      ?assertEqual(fail, parse_range_request("bytes=-20-30")),
        |  
        |      %% valid, multiple range
     1..|      ?assertEqual(
        |         [{20, 30}, {50, 100}, {110, 200}],
     1..|         parse_range_request("bytes=20-30,50-100,110-200")),
     1..|      ?assertEqual(
        |         [{20, none}, {50, 100}, {none, 200}],
     1..|         parse_range_request("bytes=20-,50-100,-200")),
        |  
        |      %% no ranges
     1..|      ?assertEqual([], parse_range_request("bytes=")),
     1..|      ok.
        |  
        |  range_skip_length_test() -&gt;
     1..|      Body = &lt;&lt;"012345678901234567890123456789012345678901234567890123456789"&gt;&gt;,
     1..|      BodySize = byte_size(Body), %% 60
     1..|      BodySize = 60,
        |  
        |      %% these values assume BodySize =:= 60
     1..|      ?assertEqual({1,9}, range_skip_length({1,9}, BodySize)), %% 1-9
     1..|      ?assertEqual({10,10}, range_skip_length({10,19}, BodySize)), %% 10-19
     1..|      ?assertEqual({40, 20}, range_skip_length({none, 20}, BodySize)), %% -20
     1..|      ?assertEqual({30, 30}, range_skip_length({30, none}, BodySize)), %% 30-
        |  
        |      %% valid edge cases for range_skip_length
     1..|      ?assertEqual({BodySize, 0}, range_skip_length({none, 0}, BodySize)),
     1..|      ?assertEqual({0, BodySize}, range_skip_length({none, BodySize}, BodySize)),
     1..|      ?assertEqual({0, BodySize}, range_skip_length({0, none}, BodySize)),
     1..|      BodySizeLess1 = BodySize - 1,
     1..|      ?assertEqual({BodySizeLess1, 1},
     1..|                   range_skip_length({BodySize - 1, none}, BodySize)),
        |  
        |      %% out of range, return whole thing
     1..|      ?assertEqual({0, BodySize},
     1..|                   range_skip_length({none, BodySize + 1}, BodySize)),
     1..|      ?assertEqual({0, BodySize},
     1..|                   range_skip_length({none, -1}, BodySize)),
        |  
        |      %% invalid ranges
     1..|      ?assertEqual(invalid_range,
     1..|                   range_skip_length({-1, 30}, BodySize)),
     1..|      ?assertEqual(invalid_range,
     1..|                   range_skip_length({0, BodySize + 1}, BodySize)),
     1..|      ?assertEqual(invalid_range,
     1..|                   range_skip_length({-1, BodySize + 1}, BodySize)),
     1..|      ?assertEqual(invalid_range,
     1..|                   range_skip_length({BodySize, 40}, BodySize)),
     1..|      ?assertEqual(invalid_range,
     1..|                   range_skip_length({-1, none}, BodySize)),
     1..|      ?assertEqual(invalid_range,
     1..|                   range_skip_length({BodySize, none}, BodySize)),
     1..|      ok.
        |  
        |  -endif.
</pre>
</body>
</html>
